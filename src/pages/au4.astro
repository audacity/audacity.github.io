---
import BaseLayout from "../layouts/BaseLayout.astro";
import "../styles/icons.css";
import {
  hasDownloadAssets,
  alphaPreRelease,
  preReleaseList,
} from "../assets/data/audacityReleases";
import SplitDownloadButton from "../components/button/SplitDownloadButton.jsx";
import FeaturedVideo from "../components/video/FeaturedVideo";

const alphaRelease = alphaPreRelease;

if (!alphaRelease) {
  throw new Error("Alpha campaign is not configured.");
}

const { downloads: alphaDownloads, status: alphaStatus } = alphaRelease;
const alphaVersion = alphaDownloads.version;

const isAlphaActive = alphaStatus === "active";

const alphaKey = alphaRelease.id;
const alphaWindowsDownloads = alphaDownloads?.win ?? [];
const alphaMacDownloads = alphaDownloads?.mac ?? [];
const alphaLinuxDownloads = alphaDownloads?.lin ?? [];

const pageTitle = `${alphaVersion} download`;
const pageDescription = isAlphaActive
  ? `Test the latest ${alphaVersion} for Windows, macOS and Linux`
  : "Audacity 4 alpha downloads are currently unavailable.";

let fallbackContent: {
  description: string;
  ctaHref: string;
  ctaLabel: string;
} | null = null;

if (!isAlphaActive) {
  const alternateActive = preReleaseList.find((entry) => {
    if (entry.status !== "active") {
      return false;
    }

    if (!hasDownloadAssets(entry.downloads)) {
      return false;
    }

    return entry.id !== alphaKey;
  });

  if (alternateActive) {
    fallbackContent = {
      description: `Check out our ${alternateActive.label.toLowerCase()} downloads instead.`,
      ctaHref: alternateActive.pageHref,
      ctaLabel: `View ${alternateActive.label.toLowerCase()} downloads`,
    };
  } else {
    fallbackContent = {
      description:
        "You can still download the latest stable version of Audacity.",
      ctaHref: "/download",
      ctaLabel: "Browse stable downloads",
    };
  }
}
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  showPromoBanner={false}
>
  <main id="main" class="max-w-screen-xl mx-auto text-gray-700">
    <div class="grid grid-cols-12 pt-8 pb-32 gap-y-12">
      <section class="col-start-2 col-span-10 sm:col-start-2 sm:col-span-5">
        <h1>{alphaVersion}</h1>
        {!isAlphaActive && fallbackContent && (
          <div class="border border-yellow-300 bg-yellow-50 text-yellow-900 rounded-md p-4 mt-4">
            <p class="font-semibold">Alpha downloads are currently unavailable.</p>
            <p class="mt-2">{fallbackContent.description}</p>
            <a
              class="hyperlink inline-flex items-center gap-1 mt-2"
              href={fallbackContent.ctaHref}
            >
              {fallbackContent.ctaLabel}
              <span class="align-middle icon icon-share text-blue-600"></span>
            </a>
          </div>
        )}
        <div class="mt-6">
          <p>
            The purpose of this alpha build is to test the core features of
            Audacity 4 on a wide selection of hardware and operating systems.
          </p>
          <p>
            If you experience severe issues or crashes, please file an issue on
            GitHub (requires a free GitHub account).
          </p>
          <ul class="py-2 list-none">
            <li>
              <a
                href="https://github.com/audacity/audacity/issues"
                class="hyperlink"
              >
                Github issues
              </a>
            </li>
          </ul>

          <h2 class="mt-6 text-2xl">What's implemented</h2>

          <ul class="list-disc mt-2 ml-6">
            <li>Recording and playback</li>
            <li>Editing audio</li>
            <li>Applying effects (destructive and real-time)</li>
            <li>Exporting audio files</li>
            <li>
              Configuring and re-arranging the interface (including the new
              Workspaces feature)
            </li>
          </ul>

          <h3 class="mt-2">A note on compatibility ⚠️</h3>
          <p class="mt-2">
            Projects saved in Audacity 4 are not backwards compatible. We
            recommend you make a copy of your important projects before opening
            them in Audacity 4.
          </p>

          <h2 class="mt-6 text-2xl">Unimplemented features</h2>
          <p class="mt-2">
            Some yet-to-be finalized features might appear non-functional, or
            have been excluded from Audacity's interface. These are features not
            yet ready for user testing, and have been disabled.
          </p>
          <ul class="list-disc mt-2 ml-6">
            <li>Nyquist, LADSPA and VAMP and the OpenVINO plugins</li>
            <li>Preferences from Audacity 3 are not carried over</li>
            <li>Envelopes and label tracks</li>
            <li>Spectrogram view and the spectral editing mode</li>
            <li>Most built-in effects, including generators and analyzers</li>
            <li>Opening multiple projects at the same time</li>
          </ul>

          <div>
            <h2 class="mt-4 text-2xl">Submit your feedback!</h2>
            <p class="mt-2">
              We're always eager to hear what you have to say, but it's
              especially important we hear from you during this early phase.
              Please let us know what you think, using the following places:
            </p>
            <ul class="py-2 list-none">
              <li class="hyperlink">
                <a href="https://forum.audacityteam.org/c/au4/64"
                  >Audacity Forum</a
                >
              </li>
              <li class="hyperlink">
                <a href="https://discord.gg/audacity">Audacity Discord</a>
              </li>
              <li>
                <a
                  href="https://github.com/audacity/audacity/issues"
                  class="hyperlink"
                >
                  Github issues
                </a>
              </li>
            </ul>
          </div>
        </div>
        <FeaturedVideo
          client:load
          placeholderImage="https://i.ytimg.com/vi/QYM3TWf_G38/maxresdefault.jpg"
          imageAltText="Video: How we made Audacity 4"
          videoURL="https://www.youtube-nocookie.com/embed/QYM3TWf_G38?autoplay=1"
          title="Video: How we made Audacity 4"
          label="Watch a behind-the-scenes video on the making of Audacity 4"
          class="mt-8"
        />
      </section>
      <aside
        class="row-start-2 sm:row-start-1 col-start-2 col-span-10 sm:col-start-8 sm:col-span-4"
      >
        <h2 class="text-sm uppercase font-normal">Download links</h2>
        {isAlphaActive ? (
          <div class="flex flex-col gap-6 mt-2">
            <div class="border border-bg-200 rounded-md p-6">
              <h3 class="additional-resource-heading">
                {alphaVersion} for Windows
              </h3>
              <div class="mt-2">
                <SplitDownloadButton OS="Windows" releaseData={alphaWindowsDownloads} client:load />
              </div>
            </div>

            <div class="border border-bg-200 rounded-md p-6">
              <h3 class="additional-resource-heading">
                {alphaVersion} for macOS
              </h3>
              <div class="mt-2">
                <SplitDownloadButton OS="macOS" releaseData={alphaMacDownloads} client:load />
              </div>
            </div>

            <div class="border border-bg-200 rounded-md p-6">
              <h3 class="additional-resource-heading">
                {alphaVersion} for Linux
              </h3>
              <div class="mt-2">
                <SplitDownloadButton OS="Linux" releaseData={alphaLinuxDownloads} client:load />
              </div>
            </div>
          </div>
        ) : (
          fallbackContent && (
            <div class="mt-4 p-4 border border-gray-200 rounded-md bg-gray-50">
              <p class="text-sm text-gray-700">{fallbackContent.description}</p>
              <a
                class="hyperlink text-sm inline-flex items-center gap-1 mt-3"
                href={fallbackContent.ctaHref}
              >
                {fallbackContent.ctaLabel}
                <span class="align-middle icon icon-share text-blue-600"></span>
              </a>
            </div>
          )
        )}
      </aside>
    </div>
  </main>
</BaseLayout>
