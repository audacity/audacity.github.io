---
import BaseLayout from "../layouts/BaseLayout.astro";
import "../styles/icons.css";
import {
  hasDownloadAssets,
  alphaPreRelease,
  betaPreRelease,
  preReleaseList,
} from "../assets/data/audacityReleases";
import SplitDownloadButton from "../components/button/SplitDownloadButton.jsx";

const betaRelease = betaPreRelease;

if (!betaRelease) {
  throw new Error("Beta campaign is not configured.");
}

const betaDownloads = betaRelease.downloads;
const betaWindowsDownloads = betaDownloads?.win ?? [];
const betaMacDownloads = betaDownloads?.mac ?? [];
const betaLinuxDownloads = betaDownloads?.lin ?? [];
const betaVersion = betaRelease.downloads.version;
const betaKey = betaRelease.id;

const isBetaActive = betaRelease.status === "active";
const alphaRelease = alphaPreRelease;
const isAlphaActive = Boolean(alphaRelease && alphaRelease.status === "active");

const pageTitle = isBetaActive
  ? "Audacity ® | Beta download"
  : "Audacity ® | Pre-release availability";
const pageDescription = isBetaActive
  ? `Test the latest ${betaVersion} for Windows, macOS and Linux`
  : "There are no beta builds available right now.";

let fallbackContent: {
  heading: string;
  message: string;
  ctaHref: string;
  ctaLabel: string;
} | null = null;

if (!isBetaActive) {
  const alternateActive = preReleaseList.find((entry) => {
  if (entry.status !== "active") {
      return false;
    }

    if (!hasDownloadAssets(entry.downloads)) {
      return false;
    }

    return entry.id !== betaKey;
  });

  if (alternateActive) {
    fallbackContent = {
      heading: `${alternateActive.label} builds available`,
      message: `We are currently sharing ${alternateActive.label.toLowerCase()} builds instead of beta releases.`,
      ctaHref: alternateActive.pageHref,
      ctaLabel: `Go to ${alternateActive.label.toLowerCase()} downloads`,
    };
  } else {
    fallbackContent = {
      heading: "No pre-release builds available",
      message: "Check back soon or download the latest stable version of Audacity.",
      ctaHref: "/download",
      ctaLabel: "Browse stable downloads",
    };
  }
}
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  showPromoBanner={false}
>
  <main id="main" class="max-w-screen-xl mx-auto">
    <div class="grid grid-cols-12 pt-8 sm:pt-20 pb-32 gap-y-12">
      <section class="col-start-2 col-span-10 sm:col-start-2 sm:col-span-5">
        <div>
          <h1>{isBetaActive ? betaVersion : "Audacity beta releases"}</h1>
          <div class="my-6">
            {isBetaActive ? (
              <p>
                Download the latest beta build and help us test upcoming
                Audacity features.
              </p>
            ) : (
              <p>
                <strong>There currently is no beta release available.</strong>
                {" "}
                Check out the options below to stay up to date.
              </p>
            )}
            <p class="my-2">
              If you'd like to help us with testing, instructions can be found
              below.
            </p>
            <div
              class="flex items-center justify-center w-fit rounded-md text-white my-6"
            >
              <a
                href="https://support.audacityteam.org/community/contributing/testing"
              >
                <div
                  class="flex items-center gap-3 h-10 pl-4 pr-3 rounded-md bg-blue-700 hover:bg-blue-600"
                >
                  Instructions for testing
                </div></a
              >
            </div>
          </div>
        </div>
        {isBetaActive ? (
          <div class="flex flex-col gap-6">
            <div class="border border-bg-200 rounded-md p-6">
              <h2 class="additional-resource-heading">
                {betaVersion} for Windows
              </h2>
              <div class="mt-2">
                <SplitDownloadButton OS="Windows" releaseData={betaWindowsDownloads} client:load />
              </div>
            </div>

            <div class="border border-bg-200 rounded-md p-6">
              <h2 class="additional-resource-heading">
                {betaVersion} for macOS
              </h2>
              <div class="mt-2">
                <SplitDownloadButton OS="macOS" releaseData={betaMacDownloads} client:load />
              </div>
            </div>

            <div class="border border-bg-200 rounded-md p-6">
              <h2 class="additional-resource-heading">
                {betaVersion} for Linux
              </h2>
              <div class="mt-2">
                <SplitDownloadButton OS="Linux" releaseData={betaLinuxDownloads} client:load />
              </div>
            </div>
          </div>
        ) : (
          fallbackContent && (
            <div class="border border-gray-200 rounded-md bg-gray-50 p-6">
              <h2 class="text-xl font-semibold text-gray-900">
                {fallbackContent.heading}
              </h2>
              <p class="mt-2 text-gray-700">{fallbackContent.message}</p>
              <a
                class="hyperlink inline-flex items-center gap-1 mt-4"
                href={fallbackContent.ctaHref}
              >
                {fallbackContent.ctaLabel}
                <span class="align-middle icon icon-share text-blue-600"></span>
              </a>
            </div>
          )
        )}
  {!isBetaActive && isAlphaActive && (
          <div class="mt-8">
            <h2 class="mt-4">Audacity 4 alpha</h2>
            <div class="flex gap-4">
              <div
                class="flex items-center justify-center w-fit rounded-md text-white my-6"
              >
                <a href="/au4">
                  <div
                    class="flex items-center gap-3 h-10 pl-4 pr-3 rounded-md bg-blue-700 hover:bg-blue-600"
                  >
                    Go to Audacity 4 alpha page
                  </div>
                </a>
              </div>
            </div>
            <p>
              <strong>Audacity 4 alpha versions are unfinished at this time.</strong>
              {" "}
              This means that some features may not work yet or placeholders may
              appear. For details, check the alpha page.
            </p>
          </div>
        )}
      </section>
    </div>
  </main>
</BaseLayout>
