---
import BaseLayout from "../layouts/BaseLayout.astro";
import OperatingSystemCard from "../components/card/OperatingSystemCard";
import "../styles/icons.css";
import {
  audacityReleases,
  hasDownloadAssets,
  preReleaseList,
  type PreReleaseEntry,
} from "../assets/data/audacityReleases";
import ChecksumAccordion from "../components/accordion/ChecksumAccordion";

const { version } = audacityReleases;
const sourceDownloads = audacityReleases.src ?? [];
const primarySourceDownload = sourceDownloads[0] ?? null;
const activeDownloadEntries = preReleaseList.filter(
  (entry) => entry.status === "active" && hasDownloadAssets(entry.downloads),
);
const hasDownloadCampaigns = activeDownloadEntries.length > 0;

const formatCampaignLinkLabel = (
  entry: PreReleaseEntry,
  platform: string,
  buildName?: string,
) =>
  `${entry.downloads.version} for ${platform}${
    buildName ? ` (${buildName})` : ""
  }`;
---

<BaseLayout
  title="Audacity Â® | Downloads"
  description="Download Audacity for Windows, macOS and Linux"
>
  <main
    id="main"
    class="max-w-screen-xl mx-auto flex-1 flex flex-col min-h-[calc(100vh-471px)]"
  >
    <div class="grid grid-cols-12 py-12 gap-y-12">
      <div class="col-start-2 col-span-10 sm:text-center">
        <h1>Downloads</h1>
        <div
          class="flex flex-col sm:flex-row justify-center sm:items-center sm:gap-2 mt-2 sm:md-4"
        >
          <p>Current version: {version}</p>
          <p class="hidden sm:block">|</p>
          <a
            class="hyperlink"
            href="https://support.audacityteam.org/additional-resources/changelog"
            target="_blank">View changelog</a
          >
        </div>
      </div>
      <section class="col-start-2 col-span-10 sm:col-start-2 sm:col-span-5">
        <h2 class="text-sm uppercase font-normal text-gray-600">
          Download for
        </h2>
        <div class="flex flex-col gap-4 mt-2">
          <OperatingSystemCard
            title="Windows"
            description="Intel: 32 & 64 bit, ARM64 (beta)"
            targetURL="/download/windows"
          />
          <OperatingSystemCard
            title="macOS"
            description="Universal Binary"
            targetURL="/download/mac"
          />
          <OperatingSystemCard
            title="Linux"
            description="64 bit appimage"
            targetURL="/download/linux"
          />
        </div>
      </section>
      <aside class="col-start-2 col-span-10 sm:col-start-8 sm:col-span-3">
        {hasDownloadCampaigns && (
          <div>
            <h2 class="text-sm uppercase font-normal text-gray-600">
              Pre-release builds
            </h2>
            <div class="flex flex-col gap-6 mt-2">
              {activeDownloadEntries.map((entry) => {
                const downloads = entry.downloads;
                const windowsBuilds = downloads.win ?? [];
                const macBuilds = downloads.mac ?? [];
                const linuxBuilds = downloads.lin ?? [];
                const versionLabel = downloads.version;

                return (
                  <div class="flex flex-col gap-3">
                    <h3 class="text-base font-semibold text-gray-900">
                      {versionLabel}
                    </h3>
                    <p class="text-sm text-gray-700">
                      {entry.summary}
                    </p>
                    <ul class="flex flex-col gap-2 text-sm">
                      {
                        windowsBuilds.map((build) => (
                          <li>
                            <a
                              class="hyperlink"
                              href={build.browser_download_url}
                            >
                              {formatCampaignLinkLabel(entry, "Windows", build.name)}
                            </a>
                          </li>
                        ))
                      }
                      {
                        macBuilds.map((build) => (
                          <li>
                            <a
                              class="hyperlink"
                              href={build.browser_download_url}
                            >
                              {formatCampaignLinkLabel(entry, "macOS", build.name)}
                            </a>
                          </li>
                        ))
                      }
                      {
                        linuxBuilds.map((build) => (
                          <li>
                            <a
                              class="hyperlink"
                              href={build.browser_download_url}
                            >
                              {formatCampaignLinkLabel(entry, "Linux", build.name)}
                            </a>
                          </li>
                        ))
                      }
                    </ul>
                    <div class="flex items-center gap-1">
                      <a href={entry.pageHref} class="hyperlink text-sm">
                        {`Learn more about ${versionLabel}`}
                      </a>
                      <span class="align-middle icon icon-share text-blue-600"></span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}
        <h2 class="text-sm uppercase font-normal text-gray-600 mt-10">
          Additional resources
        </h2>
        <div class="flex flex-col gap-6 mt-2">
          <div>
            <h3 class="additional-resource-heading">Offline manual</h3>
            <div class="gap-2">
              <a
                class="hyperlink"
                href="https://github.com/audacity/audacity-manual/releases"
                >Download Audacity manual</a
              >
              <span class="align-middle icon icon-share text-blue-600"></span>
            </div>
          </div>

          <div>
            <h3 class="additional-resource-heading">FFmpeg library</h3>
            <div class="gap-2">
              <a
                href="https://support.audacityteam.org/basics/installing-ffmpeg"
                class="hyperlink">FFmpeg import/export library</a
              >
              <span class="align-middle icon icon-share text-blue-600"></span>
            </div>
          </div>

          <div>
            <h3 class="additional-resource-heading">Source code</h3>
            <div class="flex flex-col gap-2">
              <!-- TODO - Ensure accordions are included in the tab hierarchy -->
              {primarySourceDownload ? (
                <ChecksumAccordion
                  title={primarySourceDownload.type}
                  downloadUrl={primarySourceDownload.browser_download_url}
                  checksum={primarySourceDownload.checksum}
                  client:load
                />
              ) : (
                <p class="text-sm text-gray-700">
                  Source code packages are not available right now.
                </p>
              )}
            </div>
          </div>

          <div>
            <h3 class="additional-resource-heading">
              Older versions of Audacity
            </h3>
            <div class="gap-2">
              <a
                href="https://www.fosshub.com/Audacity-old.html"
                target="_blank"
                class="hyperlink">Download older versions from Fosshub</a
              >
              <span class="align-middle icon icon-share text-blue-600"></span>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </main>
</BaseLayout>
